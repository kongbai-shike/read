<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººäº‘é˜…è¯»å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #4a6fa5;
            --primary-dark: #385d8a;
            --secondary: #6b8cbc;
            --light: #f5f7fa;
            --dark: #333;
            --gray: #e0e0e0;
            --success: #4caf50;
            --danger: #f44336;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        .login-form {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }
        
        .login-form h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray);
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .switch-form {
            text-align: center;
            margin-top: 20px;
        }
        
        .switch-form a {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }
        
        /* ä¸»ç•Œé¢æ ·å¼ */
        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .sidebar {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .upload-area {
            border: 2px dashed var(--gray);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(74, 111, 165, 0.05);
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .book-list {
            margin-top: 20px;
        }
        
        .book-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--gray);
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
        }
        
        .book-item:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        .book-icon {
            width: 40px;
            height: 40px;
            background-color: var(--secondary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            margin-right: 15px;
        }
        
        .book-info {
            flex: 1;
        }
        
        .book-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .book-meta {
            font-size: 12px;
            color: #666;
        }
        
        .book-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        
        .book-item:hover .book-actions {
            display: flex;
            gap: 5px;
        }
        
        .content-area {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: 600px;
        }
        
        .welcome-screen {
            text-align: center;
            padding: 60px 20px;
        }
        
        .welcome-icon {
            font-size: 80px;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .welcome-screen h2 {
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .welcome-screen p {
            color: #666;
            max-width: 500px;
            margin: 0 auto 30px;
        }
        
        /* é˜…è¯»å™¨æ ·å¼ */
        .reader-container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 30px;
        }
        
        .reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray);
            grid-column: 1 / -1;
        }
        
        .reader-controls {
            display: flex;
            gap: 10px;
        }
        
        .reader-content {
            line-height: 1.8;
            font-size: 18px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid var(--gray);
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .reader-content p {
            margin-bottom: 15px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .reader-content p:hover {
            background-color: rgba(74, 111, 165, 0.05);
        }
        
        .reader-content p.selected {
            background-color: rgba(74, 111, 165, 0.1);
        }
        
        .paragraph-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 5px;
        }
        
        .reader-content p.selected .paragraph-actions {
            display: flex;
        }
        
        .reader-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .bookmark-section, .comment-section {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray);
        }
        
        .bookmark-list, .comment-list {
            margin-bottom: 20px;
        }
        
        .bookmark-item, .comment-item {
            padding: 10px;
            border: 1px solid var(--gray);
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .bookmark-item:hover {
            background-color: rgba(74, 111, 165, 0.1);
        }
        
        .bookmark-meta, .comment-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .bookmark-actions, .comment-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            display: none;
        }
        
        .bookmark-item:hover .bookmark-actions,
        .comment-item:hover .comment-actions {
            display: block;
        }
        
        .comment-form {
            margin-top: 15px;
        }
        
        .comment-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray);
            border-radius: 5px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .content-area {
                order: 1;
            }
            
            .reader-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h1>ä¸ªäººäº‘é˜…è¯»å™¨</h1>
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="loginPassword">å¯†ç </label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button id="loginBtn" class="btn">ç™»å½•</button>
                <div class="switch-form">
                    <p>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a id="showRegister">æ³¨å†Œ</a></p>
                </div>
            </div>
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label for="registerUsername">ç”¨æˆ·å</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="registerPassword">å¯†ç </label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
                <button id="registerBtn" class="btn">æ³¨å†Œ</button>
                <div class="switch-form">
                    <p>å·²æœ‰è´¦å·ï¼Ÿ<a id="showLogin">ç™»å½•</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainPage" class="hidden">
        <div class="header">
            <div class="container header-content">
                <div class="logo">ä¸ªäººäº‘é˜…è¯»å™¨</div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="usernameDisplay">ç”¨æˆ·å</span>
                    <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="main-content">
                <div class="sidebar">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“š</div>
                        <h3>ä¸Šä¼ ä¹¦ç±</h3>
                        <p>æ”¯æŒ TXTã€PDFã€EPUB ç­‰æ ¼å¼</p>
                        <input type="file" id="fileInput" class="hidden" accept=".txt,.pdf,.epub,.doc,.docx">
                    </div>
                    
                    <div class="book-list">
                        <h3>æˆ‘çš„ä¹¦ç±</h3>
                        <div id="bookList">
                            <!-- ä¹¦ç±åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <div class="content-area">
                    <div id="welcomeScreen" class="welcome-screen">
                        <div class="welcome-icon">ğŸ“–</div>
                        <h2>æ¬¢è¿ä½¿ç”¨ä¸ªäººäº‘é˜…è¯»å™¨</h2>
                        <p>ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€æœ¬ä¹¦ç±ï¼Œå¼€å§‹æ„‰å¿«çš„é˜…è¯»ä½“éªŒå§ï¼</p>
                        <p>æ”¯æŒæ·»åŠ ä¹¦ç­¾ã€è¯„è®ºå’Œåˆ’çº¿ç¬”è®°åŠŸèƒ½ã€‚</p>
                    </div>

                    <div id="readerScreen" class="hidden">
                        <div class="reader-header">
                            <h3 id="currentBookTitle">ä¹¦ç±æ ‡é¢˜</h3>
                            <div class="reader-controls">
                                <button id="backToLibrary" class="btn">è¿”å›ä¹¦åº“</button>
                            </div>
                        </div>
                        
                        <div class="reader-container">
                            <div class="reader-content-area">
                                <div class="reader-content" id="readerContent">
                                    <!-- ä¹¦ç±å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                            </div>
                            
                            <div class="reader-sidebar">
                                <div class="bookmark-section">
                                    <h4 class="section-title">ä¹¦ç­¾</h4>
                                    <div class="bookmark-list" id="bookmarkList">
                                        <!-- ä¹¦ç­¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                                
                                <div class="comment-section">
                                    <h4 class="section-title">æ®µè½è¯„è®º</h4>
                                    <div class="comment-list" id="commentList">
                                        <!-- è¯„è®ºåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                    <div class="comment-form hidden" id="commentForm">
                                        <textarea id="commentText" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..."></textarea>
                                        <button id="submitCommentBtn" class="btn btn-small">æäº¤è¯„è®º</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ•°æ®åº“
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let currentUser = null;
        let books = JSON.parse(localStorage.getItem('books')) || {};
        let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || {};
        let comments = JSON.parse(localStorage.getItem('comments')) || {};
        
        // DOMå…ƒç´ 
        const loginPage = document.getElementById('loginPage');
        const mainPage = document.getElementById('mainPage');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const logoutBtn = document.getElementById('logoutBtn');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const bookList = document.getElementById('bookList');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const readerScreen = document.getElementById('readerScreen');
        const currentBookTitle = document.getElementById('currentBookTitle');
        const readerContent = document.getElementById('readerContent');
        const backToLibrary = document.getElementById('backToLibrary');
        const bookmarkList = document.getElementById('bookmarkList');
        const commentList = document.getElementById('commentList');
        const commentForm = document.getElementById('commentForm');
        const commentText = document.getElementById('commentText');
        const submitCommentBtn = document.getElementById('submitCommentBtn');
        
        // å½“å‰é€‰ä¸­çš„ä¹¦ç±å’Œæ®µè½
        let currentBookId = null;
        let selectedParagraph = null;
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // ç™»å½•/æ³¨å†Œåˆ‡æ¢
            showRegister.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });
            
            showLogin.addEventListener('click', () => {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });
            
            // ç™»å½•
            loginBtn.addEventListener('click', handleLogin);
            
            // æ³¨å†Œ
            registerBtn.addEventListener('click', handleRegister);
            
            // é€€å‡ºç™»å½•
            logoutBtn.addEventListener('click', handleLogout);
            
            // æ–‡ä»¶ä¸Šä¼ 
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            
            // è¿”å›ä¹¦åº“
            backToLibrary.addEventListener('click', () => {
                readerScreen.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
                currentBookId = null;
                selectedParagraph = null;
                commentForm.classList.add('hidden');
            });
            
            // æäº¤è¯„è®º
            submitCommentBtn.addEventListener('click', submitComment);
        }
        
        // å¤„ç†ç™»å½•
        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                showMainPage();
            } else {
                alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            }
        }
        
        // å¤„ç†æ³¨å†Œ
        function handleRegister() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            if (users[username]) {
                alert('ç”¨æˆ·åå·²å­˜åœ¨');
                return;
            }
            
            users[username] = { password };
            localStorage.setItem('users', JSON.stringify(users));
            
            // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
            if (!books[username]) books[username] = [];
            if (!bookmarks[username]) bookmarks[username] = {};
            if (!comments[username]) comments[username] = {};
            
            localStorage.setItem('books', JSON.stringify(books));
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            localStorage.setItem('comments', JSON.stringify(comments));
            
            alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
            showLogin.click();
        }
        
        // å¤„ç†é€€å‡ºç™»å½•
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            loginPage.classList.remove('hidden');
            mainPage.classList.add('hidden');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        // æ˜¾ç¤ºä¸»é¡µé¢
        function showMainPage() {
            loginPage.classList.add('hidden');
            mainPage.classList.remove('hidden');
            
            usernameDisplay.textContent = currentUser;
            userAvatar.textContent = currentUser.charAt(0).toUpperCase();
            
            loadUserBooks();
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['text/plain', 'application/pdf', 'application/epub+zip'];
            if (!allowedTypes.includes(file.type) && !file.name.endsWith('.txt') && 
                !file.name.endsWith('.pdf') && !file.name.endsWith('.epub')) {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼  TXTã€PDF æˆ– EPUB æ–‡ä»¶');
                return;
            }
            
            // æ¨¡æ‹Ÿæ–‡ä»¶è¯»å–å’Œå­˜å‚¨
            const reader = new FileReader();
            reader.onload = function(e) {
                const bookId = Date.now().toString();
                const book = {
                    id: bookId,
                    title: file.name,
                    content: e.target.result,
                    uploadDate: new Date().toLocaleDateString()
                };
                
                // ä¿å­˜åˆ°ç”¨æˆ·ä¹¦ç±åˆ—è¡¨
                books[currentUser].push(book);
                localStorage.setItem('books', JSON.stringify(books));
                
                // åˆ·æ–°ä¹¦ç±åˆ—è¡¨
                loadUserBooks();
                
                alert(`ä¹¦ç± "${file.name}" ä¸Šä¼ æˆåŠŸ`);
            };
            
            if (file.type === 'text/plain') {
                reader.readAsText(file);
            } else {
                // å¯¹äºéæ–‡æœ¬æ–‡ä»¶ï¼Œæˆ‘ä»¬åªå­˜å‚¨æ–‡ä»¶åå’Œæ¨¡æ‹Ÿå†…å®¹
                const bookId = Date.now().toString();
                const book = {
                    id: bookId,
                    title: file.name,
                    content: `è¿™æ˜¯ ${file.name} çš„æ¨¡æ‹Ÿå†…å®¹ã€‚å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨éœ€è¦å¤„ç† ${file.type} æ ¼å¼çš„æ–‡ä»¶ã€‚`,
                    uploadDate: new Date().toLocaleDateString()
                };
                
                books[currentUser].push(book);
                localStorage.setItem('books', JSON.stringify(books));
                loadUserBooks();
                alert(`ä¹¦ç± "${file.name}" ä¸Šä¼ æˆåŠŸï¼ˆæ¨¡æ‹Ÿå†…å®¹ï¼‰`);
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }
        
        // åŠ è½½ç”¨æˆ·ä¹¦ç±åˆ—è¡¨
        function loadUserBooks() {
            bookList.innerHTML = '';
            
            if (!books[currentUser] || books[currentUser].length === 0) {
                bookList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— ä¹¦ç±ï¼Œè¯·ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€æœ¬ä¹¦</p>';
                return;
            }
            
            books[currentUser].forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                bookItem.dataset.id = book.id;
                
                const fileExtension = book.title.split('.').pop().toUpperCase();
                
                bookItem.innerHTML = `
                    <div class="book-icon">${fileExtension}</div>
                    <div class="book-info">
                        <div class="book-title">${book.title}</div>
                        <div class="book-meta">ä¸Šä¼ äº ${book.uploadDate}</div>
                    </div>
                    <div class="book-actions">
                        <button class="btn btn-small btn-danger delete-book-btn">åˆ é™¤</button>
                    </div>
                `;
                
                bookItem.addEventListener('click', (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸æ‰“å¼€ä¹¦ç±
                    if (e.target.classList.contains('delete-book-btn')) {
                        return;
                    }
                    openBook(book.id);
                });
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtn = bookItem.querySelector('.delete-book-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteBook(book.id);
                });
                
                bookList.appendChild(bookItem);
            });
        }
        
        // åˆ é™¤ä¹¦ç±
        function deleteBook(bookId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿç›¸å…³çš„ä¹¦ç­¾å’Œè¯„è®ºä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) {
                return;
            }
            
            // ä»ä¹¦ç±åˆ—è¡¨ä¸­åˆ é™¤
            books[currentUser] = books[currentUser].filter(book => book.id !== bookId);
            localStorage.setItem('books', JSON.stringify(books));
            
            // åˆ é™¤ç›¸å…³çš„ä¹¦ç­¾
            if (bookmarks[currentUser] && bookmarks[currentUser][bookId]) {
                delete bookmarks[currentUser][bookId];
                localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            }
            
            // åˆ é™¤ç›¸å…³çš„è¯„è®º
            if (comments[currentUser] && comments[currentUser][bookId]) {
                delete comments[currentUser][bookId];
                localStorage.setItem('comments', JSON.stringify(comments));
            }
            
            // å¦‚æœå½“å‰æ­£åœ¨é˜…è¯»è¿™æœ¬ä¹¦ï¼Œå…³é—­é˜…è¯»å™¨
            if (currentBookId === bookId) {
                readerScreen.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
                currentBookId = null;
            }
            
            // åˆ·æ–°ä¹¦ç±åˆ—è¡¨
            loadUserBooks();
            
            alert('ä¹¦ç±åˆ é™¤æˆåŠŸ');
        }
        
        // æ‰“å¼€ä¹¦ç±
        function openBook(bookId) {
            const book = books[currentUser].find(b => b.id === bookId);
            if (!book) return;
            
            currentBookId = bookId;
            currentBookTitle.textContent = book.title;
            
            // æ˜¾ç¤ºä¹¦ç±å†…å®¹
            readerContent.innerHTML = '';
            
            // ç®€å•å¤„ç†æ–‡æœ¬å†…å®¹ï¼ŒæŒ‰æ®µè½åˆ†å‰²
            const paragraphs = book.content.split('\n').filter(p => p.trim() !== '');
            
            paragraphs.forEach((paragraph, index) => {
                const p = document.createElement('p');
                p.textContent = paragraph;
                p.dataset.index = index;
                
                // æ·»åŠ æ“ä½œæŒ‰é’®
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'paragraph-actions';
                actionsDiv.innerHTML = `
                    <button class="btn btn-small add-bookmark-btn" data-index="${index}">æ·»åŠ ä¹¦ç­¾</button>
                    <button class="btn btn-small add-comment-btn" data-index="${index}">æ·»åŠ è¯„è®º</button>
                `;
                p.appendChild(actionsDiv);
                
                p.addEventListener('click', (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æ“ä½œæŒ‰é’®ï¼Œä¸å¤„ç†æ®µè½é€‰ä¸­
                    if (e.target.classList.contains('add-bookmark-btn') || 
                        e.target.classList.contains('add-comment-btn')) {
                        return;
                    }
                    
                    // å¦‚æœå·²ç»æ˜¯é€‰ä¸­çŠ¶æ€ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
                    if (p.classList.contains('selected')) {
                        p.classList.remove('selected');
                        selectedParagraph = null;
                        commentForm.classList.add('hidden');
                    } else {
                        // ç§»é™¤ä¹‹å‰é€‰ä¸­çš„æ®µè½
                        document.querySelectorAll('.reader-content p.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        
                        // é€‰ä¸­å½“å‰æ®µè½
                        p.classList.add('selected');
                        selectedParagraph = index;
                        
                        // åŠ è½½å½“å‰æ®µè½çš„è¯„è®º
                        loadParagraphComments(index);
                    }
                });
                
                // æ·»åŠ ä¹¦ç­¾æŒ‰é’®äº‹ä»¶
                const bookmarkBtn = actionsDiv.querySelector('.add-bookmark-btn');
                bookmarkBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addBookmark(index);
                });
                
                // æ·»åŠ è¯„è®ºæŒ‰é’®äº‹ä»¶
                const commentBtn = actionsDiv.querySelector('.add-comment-btn');
                commentBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showCommentForm(index);
                });
                
                readerContent.appendChild(p);
            });
            
            // æ˜¾ç¤ºé˜…è¯»ç•Œé¢
            welcomeScreen.classList.add('hidden');
            readerScreen.classList.remove('hidden');
            
            // åŠ è½½ä¹¦ç­¾
            loadBookmarks();
        }
        
        // åŠ è½½ä¹¦ç­¾
        function loadBookmarks() {
            bookmarkList.innerHTML = '';
            
            if (!bookmarks[currentUser] || !bookmarks[currentUser][currentBookId] || 
                bookmarks[currentUser][currentBookId].length === 0) {
                bookmarkList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">æš‚æ— ä¹¦ç­¾</p>';
                return;
            }
            
            bookmarks[currentUser][currentBookId].forEach((bookmark, index) => {
                const bookmarkItem = document.createElement('div');
                bookmarkItem.className = 'bookmark-item';
                bookmarkItem.dataset.paragraph = bookmark.paragraphIndex;
                
                bookmarkItem.innerHTML = `
                    <div class="bookmark-meta">
                        <span>æ®µè½ ${parseInt(bookmark.paragraphIndex) + 1}</span>
                        <span>${bookmark.date}</span>
                    </div>
                    <div class="bookmark-content">${bookmark.note || 'æ— å¤‡æ³¨'}</div>
                    <div class="bookmark-actions">
                        <button class="btn btn-small btn-danger delete-bookmark-btn">åˆ é™¤</button>
                    </div>
                `;
                
                // åŒå‡»ä¹¦ç­¾è·³è½¬åˆ°å¯¹åº”æ®µè½
                bookmarkItem.addEventListener('dblclick', () => {
                    const paragraphIndex = parseInt(bookmarkItem.dataset.paragraph);
                    jumpToParagraph(paragraphIndex);
                });
                
                // æ·»åŠ åˆ é™¤ä¹¦ç­¾æŒ‰é’®äº‹ä»¶
                const deleteBtn = bookmarkItem.querySelector('.delete-bookmark-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteBookmark(index);
                });
                
                bookmarkList.appendChild(bookmarkItem);
            });
        }
        
        // åˆ é™¤ä¹¦ç­¾
        function deleteBookmark(bookmarkIndex) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹¦ç­¾å—ï¼Ÿ')) {
                return;
            }
            
            bookmarks[currentUser][currentBookId].splice(bookmarkIndex, 1);
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            
            // åˆ·æ–°ä¹¦ç­¾åˆ—è¡¨
            loadBookmarks();
            
            alert('ä¹¦ç­¾åˆ é™¤æˆåŠŸ');
        }
        
        // è·³è½¬åˆ°æŒ‡å®šæ®µè½
        function jumpToParagraph(paragraphIndex) {
            const paragraphs = document.querySelectorAll('.reader-content p');
            if (paragraphs.length > paragraphIndex) {
                // ç§»é™¤ä¹‹å‰é€‰ä¸­çš„æ®µè½
                document.querySelectorAll('.reader-content p.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // é€‰ä¸­ç›®æ ‡æ®µè½
                paragraphs[paragraphIndex].classList.add('selected');
                selectedParagraph = paragraphIndex;
                
                // æ»šåŠ¨åˆ°ç›®æ ‡æ®µè½
                paragraphs[paragraphIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // åŠ è½½è¯¥æ®µè½çš„è¯„è®º
                loadParagraphComments(paragraphIndex);
            }
        }
        
        // åŠ è½½æŒ‡å®šæ®µè½çš„è¯„è®º
        function loadParagraphComments(paragraphIndex) {
            commentList.innerHTML = '';
            commentForm.classList.add('hidden');
            
            if (!comments[currentUser] || !comments[currentUser][currentBookId] || 
                !comments[currentUser][currentBookId][paragraphIndex] || 
                comments[currentUser][currentBookId][paragraphIndex].length === 0) {
                commentList.innerHTML = '<p style="text-align: center; color: #666; padding: 10px;">æš‚æ— è¯„è®º</p>';
                return;
            }
            
            comments[currentUser][currentBookId][paragraphIndex].forEach((comment, index) => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                
                commentItem.innerHTML = `
                    <div class="comment-meta">
                        <span>${currentUser}</span>
                        <span>${comment.date}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-actions">
                        <button class="btn btn-small btn-danger delete-comment-btn">åˆ é™¤</button>
                    </div>
                `;
                
                // æ·»åŠ åˆ é™¤è¯„è®ºæŒ‰é’®äº‹ä»¶
                const deleteBtn = commentItem.querySelector('.delete-comment-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteComment(paragraphIndex, index);
                });
                
                commentList.appendChild(commentItem);
            });
        }
        
        // åˆ é™¤è¯„è®º
        function deleteComment(paragraphIndex, commentIndex) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
                return;
            }
            
            comments[currentUser][currentBookId][paragraphIndex].splice(commentIndex, 1);
            localStorage.setItem('comments', JSON.stringify(comments));
            
            // åˆ·æ–°è¯„è®ºåˆ—è¡¨
            loadParagraphComments(paragraphIndex);
            
            alert('è¯„è®ºåˆ é™¤æˆåŠŸ');
        }
        
        // æ˜¾ç¤ºè¯„è®ºè¡¨å•
        function showCommentForm(paragraphIndex) {
            selectedParagraph = paragraphIndex;
            commentForm.classList.remove('hidden');
            commentText.focus();
        }
        
        // æ·»åŠ ä¹¦ç­¾
        function addBookmark(paragraphIndex) {
            const note = prompt('è¯·è¾“å…¥ä¹¦ç­¾å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:');
            
            if (!bookmarks[currentUser]) bookmarks[currentUser] = {};
            if (!bookmarks[currentUser][currentBookId]) bookmarks[currentUser][currentBookId] = [];
            
            const bookmark = {
                paragraphIndex: paragraphIndex,
                note: note,
                date: new Date().toLocaleString()
            };
            
            bookmarks[currentUser][currentBookId].push(bookmark);
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            
            loadBookmarks();
            alert('ä¹¦ç­¾æ·»åŠ æˆåŠŸ');
        }
        
        // æäº¤è¯„è®º
        function submitComment() {
            const content = commentText.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }
            
            if (selectedParagraph === null) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€æ®µæ–‡æœ¬');
                return;
            }
            
            if (!comments[currentUser]) comments[currentUser] = {};
            if (!comments[currentUser][currentBookId]) comments[currentUser][currentBookId] = {};
            if (!comments[currentUser][currentBookId][selectedParagraph]) {
                comments[currentUser][currentBookId][selectedParagraph] = [];
            }
            
            const comment = {
                content: content,
                date: new Date().toLocaleString()
            };
            
            comments[currentUser][currentBookId][selectedParagraph].push(comment);
            localStorage.setItem('comments', JSON.stringify(comments));
            
            commentText.value = '';
            commentForm.classList.add('hidden');
            loadParagraphComments(selectedParagraph);
            alert('è¯„è®ºæäº¤æˆåŠŸ');
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initEventListeners();
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && users[savedUser]) {
                currentUser = savedUser;
                showMainPage();
            }
        }
        
        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>